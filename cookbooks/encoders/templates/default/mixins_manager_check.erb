#!/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
export PATH

#Custom Vars
LOG=/var/log/manager/mixin_manager-error.log
TAG='Mixin_Manager_Check_Script'
SVC='mixin_manager'
APP='mixin_manager.rb'

# End Custom vars

HOST=`hostname`
logger='logger'
writelog="${logger} -t ${TAG}"

check_error()
{
    if [ $1 -eq 0 ]; then
        SUBJECT="$2"
        BODY="$3"
                ${writelog} "${SUBJECT} ${BODY}"
        echo "`date` ${SUBJECT} ${BODY}" >> ${LOG}
                exit $1
    else
        SUBJECT="$2"
            BODY="$4"
            ${writelog} "${SUBJECT} ${BODY}"
        echo "`date` ${SUBJECT} ${BODY}" >> ${LOG}
            exit $1
    fi
}

PID=`pgrep -f ${APP}`

if [ ${PID} ]
then
    # its running so we can exit cleanly
    exit 0
else
    /bin/bash service ${SVC} start 2>&1 >/dev/null
    ST=$?
    check_error ${ST} "${TAG} detected failure in service ${SVC} on Host: ${HOST}." " Started successfully." "FAILED starting ${SVC} service with exit code ${ST}"
fi
